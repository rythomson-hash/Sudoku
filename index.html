<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sudoku Player — NYT Style</title>
<meta name="theme-color" content="#0b1220"/>
<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#0b84ff;
  --cell-bg:#fff; --cell-border:#d1d5db; --thick:#111827;
  --match:#fffbcc; --correct:#d1ffd8; --wrong:#ffd6d6;
}
[data-theme="dark"]{
  --bg:#07101a; --card:#08121a; --muted:#9aa4b2; --accent:#4aa8ff;
  --cell-bg:#07101a; --cell-border:#16222b; --thick:#e6eef8;
  --match:#2b3a2a; --correct:#123017; --wrong:#501212;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#e9eef8);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; -webkit-font-smoothing:antialiased;color:var(--thick);}
.wrap{max-width:920px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.header{display:flex;align-items:center;gap:12px;}
.header h1{margin:0;font-size:18px;}
.header .meta{margin-left:auto;color:var(--muted);font-size:13px;}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(12,22,39,0.06);border:1px solid rgba(15,23,42,0.04);}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
textarea{width:100%;min-height:86px;padding:10px;border-radius:8px;border:1px solid var(--cell-border);resize:vertical;background:transparent;color:inherit}
.btn{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:600;font-size:14px;cursor:pointer;box-shadow:0 6px 14px rgba(11,132,255,0.12)}
.btn.ghost{background:transparent;color:var(--muted);box-shadow:none;border:1px solid var(--cell-border)}
.small{font-size:12px;padding:8px 10px}
.board-wrap{display:flex;gap:16px;flex-direction:row;flex-wrap:wrap;align-items:flex-start;justify-content:center}
.board{display:grid;grid-template-columns:repeat(9,48px);gap:6px;background:transparent;touch-action:manipulation;}
.cell{width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--cell-bg);border:1px solid var(--cell-border);box-shadow:0 1px 0 rgba(0,0,0,0.02) inset;position:relative;overflow:hidden;transition:transform .12s ease, box-shadow .12s ease, background-color .18s ease;cursor:pointer;}
.cell input{width:100%;height:100%;border:0;background:transparent;font-size:20px;text-align:center;font-weight:700;outline:none;color:var(--thick);cursor:default;z-index:3;}
.cell.box-right{border-right:3px solid var(--thick);}
.cell.box-bottom{border-bottom:3px solid var(--thick);}
.clue input{font-weight:900;color:var(--thick);}
.selected{box-shadow:0 6px 20px rgba(11,132,255,0.14);transform:translateY(-2px);}
.match{background:var(--match);}
.correct-pulse{animation:correct-pulse .8s ease forwards;}
@keyframes correct-pulse{0%{background:var(--correct);transform:scale(1.02);}50%{transform:scale(1.03);}100%{transform:none;background:transparent;}}
.red-flash{animation:red-flash .8s ease forwards;}
@keyframes red-flash{0%{background:var(--wrong);transform:translateY(-2px);}60%{transform:translateY(0);}100%{background:transparent;}}
.glow{transition:box-shadow .25s ease;box-shadow:0 0 18px rgba(11,132,255,0.16);}
.conflict{outline:3px solid rgba(255,80,80,0.9);box-shadow:0 8px 30px rgba(255,40,40,0.06);}
.candidates{position:absolute;left:6px;top:6px;right:6px;bottom:6px;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:0;font-size:9px;color:var(--muted);align-items:start;pointer-events:none;z-index:1}
.candidates span{display:flex;align-items:center;justify-content:center;opacity:0.95;pointer-events:auto;cursor:pointer}
.candidates span.hidden{opacity:0;}
.candidates span.active{color:var(--thick);font-weight:700}
.cell.pencil-mode .candidates{pointer-events:auto}
#confettiCanvas{position:fixed;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:9999;}
.footer{font-size:13px;color:var(--muted);margin-top:8px}
.toggle{margin-left:auto;padding:8px;border-radius:8px;border:1px solid var(--cell-border);cursor:pointer;background:transparent}
.timerBox{display:flex;align-items:center;gap:8px;margin-left:6px}
.timeDisplay{background:rgba(0,0,0,0.04);padding:6px 10px;border-radius:8px;font-weight:700}
.bestTime{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>
<div class="wrap">
  <div class="header">
    <h1>Sudoku Player</h1>
    <div class="meta">NYT-style • Auto candidates • Timer • Pencil mode</div>
  </div>
  <div class="card">
    <textarea id="raw" placeholder="Paste 9 rows (use '.' for blanks)"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="parseBtn" class="btn small">Parse & Load</button>
      <button id="hintBtn" class="btn small" style="background:linear-gradient(180deg,#ffb86b,#ff8f3b)">Hint (1)</button>
      <button id="solveBtn" class="btn small">Auto-solve</button>
      <button id="checkBtn" class="btn ghost small">Check</button>
      <button id="exportBtn" class="btn ghost small">Export .sdk</button>
      <button id="autoCands" class="btn ghost small">Auto Candidates: OFF</button>
      <button id="pencilToggle" class="btn ghost small">Pencil Mode: OFF</button>
      <div class="timerBox">
        <div class="timeDisplay" id="timeDisplay">00:00</div>
        <button id="timerStart" class="btn small">Start</button>
        <button id="timerPause" class="btn ghost small">Pause</button>
        <button id="timerReset" class="btn ghost small">Reset</button>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <div class="bestTime" id="bestTime">Best: —</div>
          <div class="bestTime" style="font-size:11px;color:var(--muted)">Auto-start on parse/type</div>
        </div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div class="board-wrap" style="justify-content:center">
      <div id="board" class="board" aria-label="Sudoku board"></div>
    </div>
    <div class="footer" style="display:flex;align-items:center;gap:8px">
      <div>Tap a cell to type. Use Hint for one-cell help. Conflicts are highlighted in red. Click a number to highlight all of that number.</div>
      <button id="clearBtn" class="btn ghost small" style="margin-left:auto">Clear</button>
      <button id="theme" class="toggle small">Toggle Dark</button>
    </div>
  </div>
</div>

<script>
(() => {
const board=document.getElementById('board');
const raw=document.getElementById('raw');
const parseBtn=document.getElementById('parseBtn');
const solveBtn=document.getElementById('solveBtn');
const hintBtn=document.getElementById('hintBtn');
const checkBtn=document.getElementById('checkBtn');
const exportBtn=document.getElementById('exportBtn');
const clearBtn=document.getElementById('clearBtn');
const autoCandsBtn=document.getElementById('autoCands');
const pencilBtn=document.getElementById('pencilToggle');
const themeBtn=document.getElementById('theme');

const timeDisplay=document.getElementById('timeDisplay');
const timerStart=document.getElementById('timerStart');
const timerPause=document.getElementById('timerPause');
const timerReset=document.getElementById('timerReset');
const bestTimeLabel=document.getElementById('bestTime');

const confettiCanvas=document.getElementById('confettiCanvas');
const ctx=confettiCanvas.getContext('2d');

let autoCandidates=false, pencilMode=false, cachedSolution=null, currentlyHighlightedVal=null;
let timerInterval=null, elapsedMs=0, timerRunning=false, timerStartTs=0, confettiAnimating=false;

// Resize canvas
function resizeCanvas(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; }
addEventListener('resize', resizeCanvas); resizeCanvas();

// Create board
const cells=[];
for(let r=0;r<9;r++){
  for(let c=0;c<9;c++){
    const div=document.createElement('div'); div.className='cell';
    if((c+1)%3===0 && c!==8) div.classList.add('box-right');
    if((r+1)%3===0 && r!==8) div.classList.add('box-bottom');
    const inp=document.createElement('input'); inp.type='tel'; inp.inputMode='numeric'; inp.maxLength=1;
    inp.autocomplete='off';
    inp.addEventListener('input', ()=>{ inp.value=inp.value.replace(/[^1-9]/g,''); onCellInput(div,inp); });
    inp.addEventListener('focus', ()=>{ onCellFocus(div,inp); });
    inp.addEventListener('blur', ()=>{ onCellBlur(div,inp); });
    const cand=document.createElement('div'); cand.className='candidates';
    for(let v=1;v<=9;v++){
      const s=document.createElement('span'); s.textContent=v; s.dataset.val=v; s.className='hidden';
      s.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        if(!pencilMode) return;
        s.classList.toggle('active');
      });
      cand.appendChild(s);
    }
    div.appendChild(inp);
    div.appendChild(cand);
    board.appendChild(div);
    cells.push({div,inp,cand,r,c});

    // NYT-style permanent highlight
    div.addEventListener('click', e=>{
      const val=parseInt(inp.value);
      if(!val) return;
      if(currentlyHighlightedVal===val) currentlyHighlightedVal=null; else currentlyHighlightedVal=val;
      highlightMatches(currentlyHighlightedVal);
    });
  }
}

// Helpers
function getGrid(){ return cells.map(c=>c.inp.value?parseInt(c.inp.value):0); }
function setGrid(grid,clues=false){
  for(let i=0;i<81;i++){
    const val=grid[Math.floor(i/9)][i%9]||'';
    cells[i].inp.value=val;
    cells[i].div.classList.toggle('clue',clues&&val);
    cells[i].inp.readOnly=clues&&val?true:false;
  }
  refreshCandidates(); checkAndMarkConflicts();
}

function isValid(grid,r,c,val){
  for(let i=0;i<9;i++){ if(grid[r][i]===val||grid[i][c]===val) return false; }
  const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
  for(let i=0;i<3;i++) for(let j=0;j<3;j++) if(grid[br+i][bc+j]===val) return false;
  return true;
}

function computeCandidatesForCell(g,r,c){
  if(g[r*9+c]!==0) return [];
  const arr=[];
  for(let v=1;v<=9;v++) if(isValid(g,r,c,v)) arr.push(v);
  return arr;
}

function refreshCandidates(){
  const g=getGrid();
  cells.forEach(c=>{
    const spans=c.cand.querySelectorAll('span');
    if(c.inp.value){ spans.forEach(s=>s.classList.add('hidden')); return; }
    if(autoCandidates||pencilMode){
      spans.forEach(s=>{
        const val=parseInt(s.dataset.val);
        if(isValid(g,c.r*9+c.c,val)) s.classList.remove('hidden'); else s.classList.add('hidden');
      });
    } else { spans.forEach(s=>s.classList.add('hidden')); }
  });
}

function highlightMatches(val){
  currentlyHighlightedVal=val;
  cells.forEach(c=>c.div.classList.remove('match'));
  if(!val) return;
  cells.forEach(c=>{ if(c.inp.value==val) c.div.classList.add('match'); });
}

// Conflicts
function checkAndMarkConflicts(){
  cells.forEach(c=>c.div.classList.remove('conflict'));
  const g=getGrid();
  for(let r=0;r<9;r++) for(let c=0;c<9;c++){
    const val=g[r*9+c]; if(!val) continue;
    if(!isValid(g,r,c,val)) cells[r*9+c].div.classList.add('conflict');
  }
}

// Cell Events
function onCellInput(div,inp){ refreshCandidates(); checkAndMarkConflicts(); }
function onCellFocus(div,inp){ div.classList.add('selected'); highlightMatches(parseInt(inp.value)||null); }
function onCellBlur(div,inp){ div.classList.remove('selected'); }

// Parse & Load
parseBtn.addEventListener('click',()=>{
  const lines=raw.value.trim().split(/\n/).slice(0,9);
  if(lines.length!==9) return alert('Need 9 rows');
  const grid=lines.map(l=>l.padEnd(9,'.').split('').map(v=>v==='.'?0:parseInt(v)));
  setGrid(grid,true);
});

// Pencil toggle
pencilBtn.addEventListener('click',()=>{
  pencilMode=!pencilMode;
  pencilBtn.textContent=`Pencil Mode: ${pencilMode?'ON':'OFF'}`;
  cells.forEach(c=>c.div.classList.toggle('pencil-mode',pencilMode));
  refreshCandidates();
});

// Auto candidates toggle
autoCandsBtn.addEventListener('click',()=>{
  autoCandidates=!autoCandidates;
  autoCandsBtn.textContent=`Auto Candidates: ${autoCandidates?'ON':'OFF'}`;
  refreshCandidates();
});

// Clear
clearBtn.addEventListener('click',()=>{ cells.forEach(c=>{ c.inp.value=''; c.div.classList.remove('clue'); }); refreshCandidates(); });

// Theme toggle
themeBtn.addEventListener('click',()=>{
  document.documentElement.dataset.theme=document.documentElement.dataset.theme==='dark'?'light':'dark';
});

// Timer
function startTimer(){ if(timerRunning) return; timerRunning=true; timerStartTs=Date.now()-elapsedMs; timerInterval=setInterval(()=>{ elapsedMs=Date.now()-timerStartTs; timeDisplay.textContent=formatTime(elapsedMs); },1000); }
function pauseTimer(){ if(!timerRunning) return; timerRunning=false; clearInterval(timerInterval); }
function resetTimer(){ pauseTimer(); elapsedMs=0; timeDisplay.textContent='00:00'; }
function formatTime(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }
timerStart.addEventListener('click',startTimer); timerPause.addEventListener('click',pauseTimer); timerReset.addEventListener('click',resetTimer);

// Simple solver (backtracking)
function solveSudoku(g){
  function solve(grid){
    for(let r=0;r<9;r++) for(let c=0;c<9;c++){
      if(grid[r][c]===0){
        for(let v=1;v<=9;v++){
          if(isValid(grid,r,c,v)){
            grid[r][c]=v;
            if(solve(grid)) return true;
            grid[r][c]=0;
          }
        }
        return false;
      }
    }
    return true;
  }
  const grid=g.map(r=>[...r]);
  if(solve(grid)) return grid; else return null;
}

solveBtn.addEventListener('click',()=>{
  const g=getGrid();
  const grid=[];
  for(let r=0;r<9;r++) grid.push(g.slice(r*9,r*9+9));
  const solved=solveSudoku(grid);
  if(solved) setGrid(solved); else alert('No solution');
});

// Hint
hintBtn.addEventListener('click',()=>{
  const g=getGrid();
  const grid=[];
  for(let r=0;r<9;r++) grid.push(g.slice(r*9,r*9+9));
  const solved=solveSudoku(grid);
  if(!solved) return alert('No solution');
  for(let i=0;i<cells.length;i++){
    if(!cells[i].inp.value){ cells[i].inp.value=solved[Math.floor(i/9)][i%9]; cells[i].div.classList.add('correct-pulse'); refreshCandidates(); checkAndMarkConflicts(); break; }
  }
});

// Check
checkBtn.addEventListener('click',()=>{ checkAndMarkConflicts(); });

// Export
exportBtn.addEventListener('click',()=>{ const txt=getGrid().map((v,i)=>i%9===8?v+'\n':v).join(''); navigator.clipboard.writeText(txt); alert('Copied to clipboard'); });

})();
</script>
</body>
</html>
